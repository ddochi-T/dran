<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëœ¨ë€ì±„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .custom-scrollbar::-webkit-scrollbar{width:6px;height:6px}
    .custom-scrollbar::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#888;border-radius:10px}
    .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#555}
    .modal-backdrop,#loading-overlay{transition:opacity .3s ease}
    .disabled-slot{background:#f3f4f6;color:#6b7280;cursor:not-allowed}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
    <div class="loader"></div>
    <p class="text-lg font-semibold text-gray-700 mt-4">ëœ¨ë€ì±„ ì˜ˆì•½ ì‹œìŠ¤í…œ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤.</p>
  </div>

  <div class="w-full max-w-7xl bg-white rounded-2xl shadow-lg p-6 md:p-8">
    <!-- í—¤ë” -->
    <header class="mb-6">
      <div class="relative text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ëœ¨ë€ì±„ ì˜ˆì•½ ì‹œìŠ¤í…œ</h1>
        <button id="admin-login-button" class="absolute top-0 right-0 p-2 text-gray-400 hover:text-gray-600 transition-colors" title="ê´€ë¦¬ì ë¡œê·¸ì¸">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
        </button>
      </div>
      <p class="text-center text-gray-500 mb-2">ì›í•˜ëŠ” ì‹œê°„í‘œì˜ ì¹¸ì„ ëˆŒëŸ¬ ì˜ˆì•½í•˜ì„¸ìš”. (+ ë²„íŠ¼)</p>
      <div id="admin-indicator" class="hidden text-center mb-2">
        <span class="inline-block bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full cursor-pointer" title="í´ë¦­í•˜ì—¬ ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ">ê´€ë¦¬ì ëª¨ë“œ</span>
      </div>

      <!-- ì•ˆë‚´ì‚¬í•­ -->
      <div class="max-w-3xl mx-auto mt-4 mb-6 bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <div class="text-base text-blue-800 space-y-1">
              <p>1. <strong>ë°°ì • í•™ë…„ì€ ì–¸ì œë“  ì˜ˆì•½ ê°€ëŠ¥</strong>í•©ë‹ˆë‹¤.</p>
              <p>2. ë°°ì • í•™ë…„ ì™¸ íƒ€ í•™ë…„ì€ ì „ ì£¼ <strong>ëª©ìš”ì¼ ì˜¤ì „ 7ì‹œ</strong>ë¶€í„° ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-2">
          <button id="prev-week" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors duration-300" aria-label="ì´ì „ ì£¼">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
          </button>
          <h2 id="current-week" class="text-xl font-semibold w-48 text-center"></h2>
          <button id="next-week" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors duration-300" aria-label="ë‹¤ìŒ ì£¼">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
          </button>
        </div>
        <div class="flex items-center gap-3 bg-indigo-100 text-indigo-800 font-bold px-4 py-2 rounded-lg">
          <span>ì´ë²ˆ ì£¼ ë°°ì • í•™ë…„:</span>
          <span id="assigned-grade"></span>
        </div>
      </div>
    </header>

    <!-- ìº˜ë¦°ë” -->
    <div class="overflow-x-auto custom-scrollbar">
      <table class="w-full min-w-[800px] border-collapse text-center table-fixed">
        <thead id="calendar-head"></thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ì˜ˆì•½ ëª¨ë‹¬ -->
  <div id="reservation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-backdrop">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 transform transition-transform duration-300 scale-95">
      <h3 class="text-2xl font-bold mb-2">ëœ¨ë€ì±„ ì˜ˆì•½</h3>
      <p id="modal-datetime" class="text-gray-600 mb-2"></p>

      <!-- íŒíŠ¸ -->
      <div id="booking-hint" class="mb-4 hidden">
        <div class="rounded-md bg-indigo-50 text-indigo-700 text-sm px-3 py-2 leading-relaxed">
          <span id="booking-hint-text"></span>
        </div>
      </div>

      <form id="reservation-form">
        <input type="hidden" id="modal-date">
        <input type="hidden" id="modal-period">

        <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="grade-select" class="block text-sm font-medium text-gray-700 mb-1">í•™ë…„</label>
            <select id="grade-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
              <option value="1">1í•™ë…„</option><option value="2">2í•™ë…„</option><option value="3">3í•™ë…„</option>
              <option value="4">4í•™ë…„</option><option value="5">5í•™ë…„</option><option value="6">6í•™ë…„</option>
            </select>
          </div>
          <div>
            <label for="class-select" class="block text-sm font-medium text-gray-700 mb-1">ë°˜</label>
            <select id="class-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
              <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
              <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
              <option value="7">7ë°˜</option><option value="etc">ê¸°íƒ€</option>
            </select>
          </div>
        </div>

        <div id="class-input-etc-container" class="mb-4 hidden">
          <label for="class-input-etc" class="block text-sm font-medium text-gray-700 mb-1">ë°˜ ì´ë¦„ (ì§ì ‘ ì…ë ¥)</label>
          <input type="text" id="class-input-etc" placeholder="ì˜ˆ: ë°©ì†¡ë°˜" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <div class="mb-4">
          <label for="purpose" class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ìš© ëª©ì </label>
          <input type="text" id="purpose" placeholder="ì˜ˆ: ì²´ìœ¡ìˆ˜ì—…" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        </div>

        <div class="mb-6">
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì 4ìë¦¬)</label>
          <input type="tel" id="password" placeholder="ì‚­ì œ í™•ì¸ì„ ìœ„í•¨" maxlength="4" pattern="[0-9]{4}" title="ìˆ«ì 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        </div>

        <div class="flex justify-end gap-3">
          <button type="button" id="cancel-button" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
          <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">ì˜ˆì•½í•˜ê¸°</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì‚­ì œ ëª¨ë‹¬ -->
  <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-backdrop">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 transform transition-transform duration-300 scale-95">
      <h3 class="text-2xl font-bold mb-2">ì˜ˆì•½ ì‚­ì œ</h3>
      <div class="bg-gray-100 p-4 rounded-lg mb-6 text-gray-700">
        <p><strong class="font-semibold">ì‹œê°„:</strong> <span id="delete-modal-datetime"></span></p>
        <p><strong class="font-semibold">í•™ë…„ë°˜:</strong> <span id="delete-modal-grade-class"></span></p>
        <p><strong class="font-semibold">ëª©ì :</strong> <span id="delete-modal-purpose"></span></p>
      </div>
      <form id="delete-form">
        <input type="hidden" id="delete-modal-date">
        <input type="hidden" id="delete-modal-period">
        <div class="mb-6">
          <label for="delete-password" class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì 4ìë¦¬)</label>
          <input type="tel" id="delete-password" placeholder="ì˜ˆì•½ ì‹œ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸" maxlength="4" pattern="[0-9]{4}" title="ìˆ«ì 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="delete-cancel-button" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
          <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">ì‚­ì œí•˜ê¸°</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-backdrop">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 transform transition-transform duration-300 scale-95">
      <h3 class="text-2xl font-bold mb-4 text-center">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
      <form id="admin-form">
        <div class="mb-4">
          <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">ê´€ë¦¬ì ì•”í˜¸</label>
          <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="admin-cancel-button" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
          <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">ë¡œê·¸ì¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì•Œë¦¼ ëª¨ë‹¬ -->
  <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-backdrop">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 transform transition-transform duration-300 scale-95 text-center">
      <div id="alert-message" class="text-gray-800 text-lg mb-6"></div>
      <button id="alert-close-button" class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">í™•ì¸</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script>window.__app_id = 'dran-auditorium-reservation';</script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDocFromServer } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ğŸ” Firebase Web SDK ì„¤ì • (dran-aad51 í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´)
    // Firebase ì½˜ì†” â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ 'ë‚´ ì•±' â†’ Web ì•±ì—ì„œ ì•„ë˜ ê°’ì„ ë³µì‚¬í•´ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "dran-aad51",
      storageBucket: "dran-aad51.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ------------------- ì•± ìƒíƒœ ------------------- //
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const reservationsCol = collection(db, `artifacts/${appId}/public/data/reservations`);

    document.addEventListener('DOMContentLoaded', () => {
      // --- ìƒíƒœ
      let currentDate = new Date('2025-09-01'); // 9/1~9/10ì€ ë°©í•™ ì²˜ë¦¬
      let reservations = {};
      let isAdmin = false;
      const ADMIN_PASSWORD = "school0000";

      // --- DOM
      const loadingOverlay = document.getElementById('loading-overlay');
      const currentWeekEl = document.getElementById('current-week');
      const calendarHeadEl = document.getElementById('calendar-head');
      const calendarBodyEl = document.getElementById('calendar-body');
      const assignedGradeEl = document.getElementById('assigned-grade');
      const prevWeekBtn = document.getElementById('prev-week');
      const nextWeekBtn = document.getElementById('next-week');

      const reservationModal = document.getElementById('reservation-modal');
      const modalDatetimeEl = document.getElementById('modal-datetime');
      const modalDateInput = document.getElementById('modal-date');
      const modalPeriodInput = document.getElementById('modal-period');
      const gradeSelect = document.getElementById('grade-select');
      const classSelect = document.getElementById('class-select');
      const classInputEtcContainer = document.getElementById('class-input-etc-container');
      const classInputEtc = document.getElementById('class-input-etc');
      const purposeInput = document.getElementById('purpose');
      const passwordInput = document.getElementById('password');
      const reservationForm = document.getElementById('reservation-form');
      const cancelButton = document.getElementById('cancel-button');

      const deleteModal = document.getElementById('delete-modal');
      const deleteModalDatetimeEl = document.getElementById('delete-modal-datetime');
      const deleteModalGradeClassEl = document.getElementById('delete-modal-grade-class');
      const deleteModalPurposeEl = document.getElementById('delete-modal-purpose');
      const deleteModalDateInput = document.getElementById('delete-modal-date');
      const deleteModalPeriodInput = document.getElementById('delete-modal-period');
      const deletePasswordInput = document.getElementById('delete-password');
      const deleteForm = document.getElementById('delete-form');
      const deleteCancelButton = document.getElementById('delete-cancel-button');

      const adminModal = document.getElementById('admin-modal');
      const adminLoginButton = document.getElementById('admin-login-button');
      const adminForm = document.getElementById('admin-form');
      const adminPasswordInput = document.getElementById('admin-password');
      const adminCancelButton = document.getElementById('admin-cancel-button');
      const adminIndicator = document.getElementById('admin-indicator');

      const alertModal = document.getElementById('alert-modal');
      const alertMessageEl = document.getElementById('alert-message');
      const alertCloseButton = document.getElementById('alert-close-button');

      // íŒíŠ¸ DOM
      const bookingHintWrapEl = document.getElementById('booking-hint');
      const bookingHintTextEl = document.getElementById('booking-hint-text');

      // ------------------- ì£¼ ë°°ì •í‘œ (ì²¨ë¶€í‘œ ë°˜ì˜) ------------------- //
      // 2025-09-08(ì›”) ì‹œì‘, 21ì£¼ ì‹œí€€ìŠ¤: [1,1,1,2,null,2,3,3,6,5,4,1,1,2,2,3,3,4,5,6,6]
      const gradeAssignments = {
        '2025-09-08': 1, '2025-09-15': 1, '2025-09-22': 1, '2025-09-29': 2,
        '2025-10-06': null, '2025-10-13': 2, '2025-10-20': 3, '2025-10-27': 3,
        '2025-11-03': 6, '2025-11-10': 5, '2025-11-17': 4, '2025-11-24': 1,
        '2025-12-01': 1, '2025-12-08': 2, '2025-12-15': 2, '2025-12-22': 3,
        '2025-12-29': 3, '2026-01-05': 4, '2026-01-12': 5, '2026-01-19': 6,
        '2026-01-26': 6
      };

      // ê³µíœ´ì¼/íœ´ì—…ì¼ (í•„ìš” ì‹œ ììœ  ìˆ˜ì •)
      const holidays = {
        '2025-09-01':'ì—¬ë¦„ë°©í•™','2025-09-02':'ì—¬ë¦„ë°©í•™','2025-09-03':'ì—¬ë¦„ë°©í•™','2025-09-04':'ì—¬ë¦„ë°©í•™','2025-09-05':'ì—¬ë¦„ë°©í•™',
        '2025-09-08':'ì—¬ë¦„ë°©í•™','2025-09-09':'ì—¬ë¦„ë°©í•™','2025-09-10':'ì—¬ë¦„ë°©í•™',
        '2025-10-03':'ê°œì²œì ˆ','2025-10-06':'ì¶”ì„ì—°íœ´','2025-10-07':'ì¶”ì„ì—°íœ´','2025-10-08':'ì¶”ì„ì—°íœ´',
        '2025-10-09':'í•œê¸€ë‚ ','2025-10-10':'ììœ¨íœ´ì—…ì¼','2025-12-25':'í¬ë¦¬ìŠ¤ë§ˆìŠ¤','2026-01-01':'ìƒˆí•´ ì²«ë‚ '
      };

      // êµì‹œí‘œ(ë°°ì •í•™ë…„ì— ë”°ë¼ ì ì‹¬ ìœ„ì¹˜/ì‰¬ëŠ”ì‹œê°„ ë°˜ì˜)
      const timetables = {
        '1-2':['1êµì‹œ (08:50~09:30)','2êµì‹œ (09:40~10:20)','3êµì‹œ (10:30~11:10)','ì ì‹¬ (11:10~11:50)','4êµì‹œ (11:50~12:30)','5êµì‹œ (12:40~13:20)','6êµì‹œ (13:30~14:10)'],
        '3-4':['1êµì‹œ (08:50~09:30)','2êµì‹œ (09:40~10:20)','3êµì‹œ (10:30~11:10)','4êµì‹œ (11:20~12:00)','ì ì‹¬ (12:00~12:40)','5êµì‹œ (12:40~13:20)','6êµì‹œ (13:30~14:10)'],
        '5-6':['1êµì‹œ (08:50~09:30)','2êµì‹œ (09:40~10:20)','3êµì‹œ (10:30~11:10)','4êµì‹œ (11:20~12:00)','5êµì‹œ (12:10~12:50)','ì ì‹¬ (12:50~13:30)','6êµì‹œ (13:30~14:10)'],
      };
      const daysOfWeek = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];

      // ------------------- ìœ í‹¸ ------------------- //
      const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth()+1).padStart(2,'0');
        const d = String(date.getDate()).padStart(2,'0');
        return `${y}-${m}-${d}`;
      };
      const getMonday = (date) => {
        const d = new Date(date);
        const day = d.getDay(); // 0(ì¼)~6(í† )
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        d.setDate(diff);
        return new Date(d);
      };
      const getAssignedGrade = (date) => {
        const monday = getMonday(date);
        const dateString = formatDate(monday);
        return gradeAssignments[dateString] ?? null;
      };
      const getOpenBookingDate = (date) => {
        const monday = getMonday(date);
        const open = new Date(monday);
        open.setDate(monday.getDate() - 4); // ì „ì£¼ ëª©ìš”ì¼
        open.setHours(7,0,0,0);
        return open;
      };

      const updateBookingHint = () => {
        if (!bookingHintWrapEl || !bookingHintTextEl || !modalDateInput || !gradeSelect) return;
        const selectedDateStr = modalDateInput.value;
        if (!selectedDateStr) { bookingHintWrapEl.classList.add('hidden'); return; }

        const selectedDate  = new Date(selectedDateStr);
        const assignedGrade = getAssignedGrade(selectedDate);
        const selectedGrade = parseInt(gradeSelect.value);
        const open          = getOpenBookingDate(selectedDate);
        const now           = new Date();

        if (selectedGrade === assignedGrade || isAdmin) { bookingHintWrapEl.classList.add('hidden'); return; }
        if (now < open) {
          bookingHintTextEl.innerHTML =
            `íƒ€ í•™ë…„ì€ <strong class="text-indigo-600">${open.getMonth()+1}ì›” ${open.getDate()}ì¼ ì˜¤ì „ 7ì‹œ</strong>ë¶€í„° ì˜ˆì•½ ê°€ëŠ¥`;
          bookingHintWrapEl.classList.remove('hidden');
        } else {
          bookingHintWrapEl.classList.add('hidden');
          bookingHintTextEl.textContent = '';
        }
      };

      const renderCalendar = () => {
        calendarHeadEl.innerHTML = '';
        calendarBodyEl.innerHTML = '';

        const monday = getMonday(currentDate);
        const weekDates = [];

        const weekStart = new Date(monday);
        const weekEnd = new Date(monday); weekEnd.setDate(weekEnd.getDate()+4);
        currentWeekEl.textContent = `${weekStart.getMonth()+1}.${weekStart.getDate()} ~ ${weekEnd.getMonth()+1}.${weekEnd.getDate()}`;

        const assignedGrade = getAssignedGrade(currentDate);
        assignedGradeEl.textContent = assignedGrade ? `${assignedGrade}í•™ë…„` : 'ë°°ì • ì—†ìŒ';

        const headRow = document.createElement('tr');
        headRow.innerHTML = '<th class="w-48 py-3 border-b-2 border-gray-200"></th>';
        for (let i=0;i<5;i++){
          const dayDate = new Date(monday); dayDate.setDate(monday.getDate()+i);
          weekDates.push(dayDate);
          const th = document.createElement('th');
          th.className = "py-3 border-b-2 border-gray-200";
          th.innerHTML = `<span class="text-xl font-bold text-gray-800">${dayDate.getMonth()+1}/${dayDate.getDate()}</span><br><span class="text-base font-medium text-gray-500">(${daysOfWeek[i]})</span>`;
          headRow.appendChild(th);
        }
        calendarHeadEl.appendChild(headRow);

        // ë°°ì •í•™ë…„ì— ë”°ë¼ ì‹œê°„í‘œ ì„ íƒ
        let key;
        if (assignedGrade >= 5) key='5-6';
        else if (assignedGrade >= 3) key='3-4';
        else if (assignedGrade >= 1) key='1-2';
        else key='3-4';
        const timetable = timetables[key];

        // 9/1~9/10 ë°©í•™ ì²˜ë¦¬
        const vacationEndDate = new Date('2025-09-10'); vacationEndDate.setHours(23,59,59,999);

        timetable.forEach((period, periodIndex) => {
          const row = document.createElement('tr');
          row.className = "border-b border-gray-100";

          const timeTd = document.createElement('td');
          timeTd.className = "py-3 px-2 border-r border-gray-100 font-semibold text-gray-800 leading-tight";

          const match = period.match(/(.*?)\s*\((.*)\)/);
          if (match) timeTd.innerHTML = `<span class="text-lg">${match[1]}</span><br><span class="text-sm font-normal text-gray-500">(${match[2]})</span>`;
          else timeTd.innerHTML = `<span class="text-lg">${period}</span>`;
          row.appendChild(timeTd);

          weekDates.forEach((date, dayIndex) => {
            const cell = document.createElement('td');
            const innerDiv = document.createElement('div');
            innerDiv.className = "h-20 flex flex-col justify-center items-center rounded-lg";
            const dateString = formatDate(date);
            const holidayName = holidays[dateString];
            const reservationKey = `${dateString}_${period}`;
            const reservation = reservations[reservationKey];

            cell.dataset.date = dateString;
            cell.dataset.period = period;

            if (date <= vacationEndDate || holidayName === 'ì—¬ë¦„ë°©í•™') {
              cell.className = "py-2 px-1";
              innerDiv.classList.add('disabled-slot','text-red-500','font-bold');
              innerDiv.textContent = 'ì—¬ë¦„ë°©í•™';
            } else if (holidayName) {
              cell.className = "py-2 px-1";
              innerDiv.classList.add('disabled-slot','text-red-500','font-bold');
              innerDiv.textContent = holidayName;
            } else if (dayIndex === 2 && /6êµì‹œ/.test(period)) { // ìˆ˜ìš”ì¼ 6êµì‹œ ê¸ˆì§€
              cell.className = "py-2 px-1";
              innerDiv.classList.add('disabled-slot');
              innerDiv.textContent = 'ì˜ˆì•½ ë¶ˆê°€';
            } else if (reservation) {
              cell.className = "py-2 px-1 relative cursor-pointer";
              innerDiv.classList.add('bg-indigo-200','text-indigo-800','hover:bg-indigo-300','transition-colors');
              innerDiv.innerHTML = `<span class="font-bold text-base">${reservation.gradeClass}</span><span class="text-sm mt-1 break-words px-1">${reservation.purpose}</span>`;
            } else {
              cell.className = "py-2 px-1 relative cursor-pointer";
              innerDiv.classList.add('bg-gray-50','hover:bg-green-100','transition-colors');
              innerDiv.innerHTML = `<span class="text-gray-400 text-2xl">+</span>`;
            }
            cell.appendChild(innerDiv);
            row.appendChild(cell);
          });
          calendarBodyEl.appendChild(row);
        });
      };

      // ëª¨ë‹¬ helpers
      const openModal = (el) => { el.classList.remove('hidden'); el.classList.add('flex'); setTimeout(() => { el.querySelector('div').classList.remove('scale-95'); }, 10); };
      const closeModal = (el) => { el.querySelector('div').classList.add('scale-95'); setTimeout(() => { el.classList.add('hidden'); el.classList.remove('flex'); }, 300); };
      const openAlertModal = (msg) => { alertMessageEl.innerHTML = msg; openModal(alertModal); };

      // ì´ë²¤íŠ¸
      prevWeekBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate()-7); renderCalendar(); });
      nextWeekBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate()+7); renderCalendar(); });

      calendarBodyEl.addEventListener('click', (e) => {
        const cell = e.target.closest('td[data-date]');
        if (!cell || cell.querySelector('.disabled-slot')) return;

        const { date, period } = cell.dataset;
        const reservationKey = `${date}_${period}`;
        const reservation = reservations[reservationKey];

        const dateObj = new Date(date);
        const dayOfWeek = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dateObj.getDay()];

        if (reservation) {
          // ì‚­ì œ ëª¨ë‹¬
          deleteModalDateInput.value = date;
          deleteModalPeriodInput.value = period;
          deleteModalDatetimeEl.textContent = `${dateObj.getMonth()+1}ì›” ${dateObj.getDate()}ì¼ (${dayOfWeek}) ${period}`;
          deleteModalGradeClassEl.textContent = reservation.gradeClass;
          deleteModalPurposeEl.textContent = reservation.purpose;
          deleteForm.reset();
          openModal(deleteModal);
        } else {
          // ì˜ˆì•½ ëª¨ë‹¬
          reservationForm.reset();
          classInputEtcContainer.classList.add('hidden');
          classInputEtc.required = false;

          document.getElementById('modal-date').value = date;
          document.getElementById('modal-period').value = period;
          document.getElementById('modal-datetime').textContent = `${dateObj.getMonth()+1}ì›” ${dateObj.getDate()}ì¼ (${dayOfWeek}) ${period}`;

          openModal(reservationModal);
          setTimeout(() => { try{ updateBookingHint(); }catch(e){ console.error(e); } }, 0);
        }
      });

      // í¼ í•¸ë“¤ë§
      classSelect.addEventListener('change', () => {
        if (classSelect.value === 'etc') { classInputEtcContainer.classList.remove('hidden'); classInputEtc.required = true; }
        else { classInputEtcContainer.classList.add('hidden'); classInputEtc.required = false; }
        updateBookingHint();
      });
      gradeSelect.addEventListener('change', updateBookingHint);

      reservationForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const selectedDate  = new Date(modalDateInput.value);
        const assignedGrade = getAssignedGrade(selectedDate);
        const selectedGrade = parseInt(gradeSelect.value);

        if (!isAdmin) {
          const now = new Date();
          const openBookingDate = getOpenBookingDate(selectedDate);
          if (selectedGrade !== assignedGrade && now < openBookingDate) {
            const message = `íƒ€ í•™ë…„ì€<br><strong class="text-indigo-600">${openBookingDate.getMonth()+1}ì›” ${openBookingDate.getDate()}ì¼ ì˜¤ì „ 7ì‹œ</strong><br>ë¶€í„° ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
            openAlertModal(message);
            return;
          }
        }

        const date = modalDateInput.value;
        const period = modalPeriodInput.value;

        let className;
        if (classSelect.value === 'etc') className = classInputEtc.value.trim();
        else className = `${classSelect.value}ë°˜`;

        const gradeClass = `${gradeSelect.value}í•™ë…„ ${className}`;
        const purpose = purposeInput.value.trim();
        const password = passwordInput.value.trim();

        if (!purpose || !password || password.length !== 4 || !/^\d{4}$/.test(password)) {
          openAlertModal('ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ëª©ì , ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬)');
          return;
        }

        const reservationKey = `${date}_${period}`;
        const reservationData = { gradeClass, purpose, password };

        try {
          const docSnap = await getDocFromServer(doc(reservationsCol, reservationKey));
          if (docSnap.exists()) {
            openAlertModal("ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë¨¼ì € ì˜ˆì•½í–ˆìŠµë‹ˆë‹¤.<br>í˜ì´ì§€ê°€ ê³§ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.");
          } else {
            await setDoc(doc(reservationsCol, reservationKey), reservationData);
            closeModal(reservationModal);
          }
        } catch (error) {
          console.error("Error adding document: ", error);
          openAlertModal("ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      // ì‚­ì œ
      deleteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const date = deleteModalDateInput.value;
        const period = deleteModalPeriodInput.value;
        const password = deletePasswordInput.value.trim();
        const reservationKey = `${date}_${period}`;

        const docSnap = await getDocFromServer(doc(reservationsCol, reservationKey));
        if (docSnap.exists() && (docSnap.data().password === password || isAdmin)) {
          try { await deleteDoc(doc(reservationsCol, reservationKey)); closeModal(deleteModal); }
          catch (error) { console.error("Error removing document: ", error); openAlertModal("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        } else {
          openAlertModal('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      });

      // ê´€ë¦¬ì
      adminLoginButton.addEventListener('click', () => openModal(adminModal));
      adminForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (adminPasswordInput.value === "school0000") { isAdmin = true; adminIndicator.classList.remove('hidden'); closeModal(adminModal); adminForm.reset(); }
        else { openAlertModal("ê´€ë¦¬ì ì•”í˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
      });
      adminIndicator.addEventListener('click', () => { isAdmin = false; adminIndicator.classList.add('hidden'); openAlertModal("ê´€ë¦¬ì ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); });

      // ëª¨ë‹¬ ë‹«ê¸°
      document.getElementById('cancel-button').addEventListener('click', () => closeModal(reservationModal));
      document.getElementById('delete-cancel-button').addEventListener('click', () => closeModal(deleteModal));
      document.getElementById('admin-cancel-button').addEventListener('click', () => closeModal(adminModal));
      document.getElementById('alert-close-button').addEventListener('click', () => closeModal(alertModal));
      reservationModal.addEventListener('click', (e) => { if (e.target === reservationModal) closeModal(reservationModal); });
      deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeModal(deleteModal); });
      alertModal.addEventListener('click', (e) => { if (e.target === alertModal) closeModal(alertModal); });

      // Firebase init + ì‹¤ì‹œê°„ ë°˜ì˜
      const initializeFirebase = async () => {
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
          openAlertModal("<strong class='text-red-500'>Firebase ì„¤ì • í•„ìš”</strong><br><br>ì½”ë“œì˜ <code>firebaseConfig</code>ë¥¼<br>dran-aad51 Web ì•± ê°’ìœ¼ë¡œ ì±„ìš°ì„¸ìš”.");
          loadingOverlay.classList.add('opacity-0'); setTimeout(() => loadingOverlay.style.display='none', 300); return;
        }
        try {
          await signInAnonymously(auth);
          let isInitialLoad = true;
          onSnapshot(reservationsCol, (querySnapshot) => {
            const newReservations = {};
            querySnapshot.forEach((doc) => { newReservations[doc.id] = doc.data(); });
            reservations = newReservations;
            renderCalendar();
            if (isInitialLoad) { loadingOverlay.classList.add('opacity-0'); setTimeout(() => loadingOverlay.style.display='none', 300); isInitialLoad = false; }
          }, (error) => {
            console.error("Error listening to reservations: ", error);
            openAlertModal("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
            loadingOverlay.classList.add('opacity-0'); setTimeout(() => loadingOverlay.style.display='none', 300);
          });
        } catch (error) {
          console.error("Firebase initialization error:", error);
          if (error.code === 'auth/operation-not-allowed') {
            openAlertModal("ìµëª… ë¡œê·¸ì¸ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br><br><strong>í•´ê²°:</strong> Firebase ì½˜ì†” â†’ Authentication â†’ Sign-in method â†’ ìµëª… ì‚¬ìš© 'í™œì„±í™”'");
          } else {
            openAlertModal("ì‹œìŠ¤í…œ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
          }
          loadingOverlay.classList.add('opacity-0'); setTimeout(() => loadingOverlay.style.display='none', 300);
        }
      };
      initializeFirebase();
    });
  </script>
</body>
</html>
